===============================================
Lab: Data Model for an "Internet of Things" App
===============================================

Introduction
------------

- Consider an internet-connected pill bottle.
- It will:

  - Weigh its contents.
  - Track how many pills it contains.
  - Notify the user if they are late in taking a pill.

.. include:: /includes/student-notes.rst


Pill Bottle Information
-----------------------

- **pill** - the type of pill contained in the bottle.
- **mass** - the mass of the bottle's contents
- **mass per pill** - the mass of one of the pills contained in the bottle
- **number of pills**  - the number of pills in the bottle

  - estimated by the bottle

- **Events** - When the bottle is opened/closed, how many pills added/removed
- **Heartbeat** - Confirming that the bottle is connected to wi-fi

.. include:: /includes/student-notes.rst


Pill Bottle Operations
----------------------

Each pill bottle will perform the following queries:

.. rst-class:: longlist

  - A query to find the user it's associated with, plus the medication and
    dosage.

    - Frequency: very rarely; assume it would change 1/year.
    - Information: username, medication ID, medication mass per pill, frequency
      of dosage

  - A heartbeat.

    - Frequency: once every 10 minutes

.. include:: /includes/student-notes.rst


Pill Bottle Operations (cont'd)
-------------------------------

- An operation to log the time, the mass, the estimated number of pills in
  the bottle, and the number of pills taken while the bottle was opened.

  - Frequency: 1-6 times per bottle per day (assume an average of 3)

.. include:: /includes/student-notes.rst


Other Application Operations
----------------------------

There will also be a web and notification server which will do the following:

.. rst-class:: longlist

  - For each bottle, query 1/hour to determine:

    - Which customers are more than an hour late in taking a pill
    - Which pill bottles have not called in for a heartbeat for over an hour

  - Query each time user logs in to a web site to generate a calendar showing
    on which days they take their pills and which days they miss one or more

    - Assume an average of 1/week

.. include:: /includes/student-notes.rst


Other Application Operations (cont'd)
-------------------------------------

- Store user contact information, bottle information, etc. when an account is
  created

  - Assume an average user has been on the system for 1 year, so 1/year.

.. include:: /includes/student-notes.rst

.. only:: instructor

  .. note::

    - If one of the students asks if it's even necessary to optimize this
      application, remind them that any product will face two possible paths
      down the line: it will scale, or it will fail.

      - If demand never picks up, the product will be dropped, and nothing will
        matter.
      - If demand does pick up, they'll want the system to work as efficiently
        as possible to minimize cost & hassle for any given load.


Deliverables
------------

Break into groups of two or three and work together to create the following
deliverables:

- Assumptions about sizing

  - number of documents per collection
  - frequency of requests

- Sample documents for each collection you're creating
- Queries the application will use
- Index creation commands
- Should you shard some collections? Now? Later?

  - Let's assume that you'd like for it to take off, and the market is up to 1
    billion customers, worldwide.

.. include:: /includes/student-notes.rst


Solution
--------

All slides from now on should be shown only after a solution is found by the
groups & presented.

.. include:: /includes/student-notes.rst


Solution - Sizing for Operations
--------------------------------

- Assume 100M customers in the first 3 years (up to 1B later)
- Average of 3 bottles per customer
- Operations:

  - 3 * 100M / 600 sec = 5M heartbeats per second (inserts)
  - 3 * 100M / 3600 sec = 86K checks per second for most recent heartbeat
  - 3 * 100M * 3 pills / day / 86400 seconds per day = 10K checks per second
    for missed pills

    - Might be more, because not every user will have taken their pill

  - If 1 percent of users miss a pill per day, and it takes an average of 2
    notifications before they take it, then there might be 200 more
    notifications per second, plus checks for when that gets in place.

.. include:: /includes/student-notes.rst


Solution - Sizing for Data
--------------------------

Data size:

- Bottle information: 300M bottles * 100 bytes = 30GB
- User information: 100M customers * 1000 bytes = 100GB
- Heartbeats: 300M bottles * 1008 documents/week * 100 bytes
  = 30TB/week

.. include:: /includes/student-notes.rst


Solution - Collections
----------------------

- users

  - Contact Information
  - Bottles they're linked to, and medication associated with each bottle
  - Medications they take

    - Frequency of medication

.. include:: /includes/student-notes.rst


Solution - Collections (cont'd)
-------------------------------

- bottle_actions

  - Medication associated with the bottle
  - Mass of contents
  - Estimated number of pills
  - Timestamp of measurement
  - Action: opened, or closed
  - If closed, number of pills added/removed

.. include:: /includes/student-notes.rst


Solution - Collections (cont'd)
-------------------------------

- bottle_heartbeats

  - ``bottle_id``
  - Medication associated with the bottle
  - ``user_id``
  - timestamp

.. include:: /includes/student-notes.rst


Solution - Collections (cont'd)
-------------------------------

- medications

  - Link to an image of the medication
  - Type of medication (pill, capsule, or liquid)
  - Information on the medication (string)

- notifications

  - Timestamp
  - Type (SMS, email)
  - Message
  - Email or phone it's getting sent to

.. include:: /includes/student-notes.rst


Solution - Considerations
-------------------------

- There will be duplication of information between the ``Medications``
  collection and the ``Users`` collection.
- Capturing the most recent "heartbeat" will be the most common operation, and
  we should optimize for that.

  - However, it's an insert. Optimizing for it
    consists of keeping the number of indexes small.

  - Another common operation is checking to see if there were any heartbeats
    in the last hour. Optimize for that, instead.

- Are there any health data regulation that requires us to keep the
  last X heartbeats or actions from a user for a period of time?

.. include:: /includes/student-notes.rst


Solution: Document - users (1 of 3)
-----------------------------------

.. code-block:: javascript

  {
    _id : "willcross", password_hash : "...",
    user: {
      last_name : "Cross",
      first_name : "William",
      honorific : "Dr."
    },  ... // continued on next slide

.. include:: /includes/student-notes.rst


Solution: Document - users (2 of 3)
-----------------------------------

.. code-block:: javascript

  {
    ... ,
    contact_info : {
      addresses: [ {
        street : "229 West 43rd Street, 5th Floor",
        city : "New York",
        state : "NY",
        zip : "07302",
        type : "work",
        primary : true
      } ],
      phone_numbers : [ {
        type : "cell",
        number : "(555)555-5555",
        send_notifications : true
      } ],
      email : [ { address : "will@mongodb.com", send_notifications : true },
                { address : "will@mailinator.com", send_notifications : false } ]
    }, ...  // continued on next slide

.. include:: /includes/student-notes.rst


Solution: Document - users (3 of 3)
-----------------------------------

.. code-block:: javascript

  {
    ... ,
    bottles : [ {
        _id : ObjectId(...),
        medication_id : ObjectId(...),
        medication_name : "Cordrazine",
        medication_dosage : { quantity : 1, unit : "pill", times_per_day : 2 },
        mass_in_grams : 1.77,
        image : "http://s.quickmeme.com/img/94/945bdf761cb888c7c8e829878ed3b5a0221fd0d10db7b5697834ded0ad592c93.jpg"
      }, {
        _id : ObjectId(...),
        medication_id : ObjectId(...),
        medication_name : "Felicium",
        medication_dosage : { quantity : 2, unit : "pill", times_per_day : 3 },
        mass_in_grams : 2.7,
        image : "http://www.ex-astris-scientia.org/gallery/factfiles/felicium-dispenser-symbiosis.jpg"
      } ]
  }  // End of the users document

.. include:: /includes/student-notes.rst


Solution: Document - bottle_action
----------------------------------

.. code-block:: javascript

  {
    _id : ObjectId(...),
    bottle_id : ObjectId(...),
    user_id : "..."
    mass_of_contents : 44.25,
    number_of_pills : 25,
    time : ISODate(...),
    action : "closed",  // other possible value: "opened"
    pills_taken : 1
  }  // pills_taken will be present only for the "closed" action.

.. include:: /includes/student-notes.rst


Solution: Document - bottle_heartbeats
--------------------------------------

.. code-block:: javascript

  {
    _id : ObjectId(...),
    bottle_id : ObjectId(...),
    medication : "Cordrazine",
    user_id : "...",
    time : ISODate(...)
  }

.. include:: /includes/student-notes.rst


Solution: Document - notifications
----------------------------------

.. code-block:: javascript

  {
    _id : ObjectId(...),
    user_id : ObjectId(...),
    time_sent : ISODate(...),
    type : "SMS",
    target : "(555) 555-5555",
    message : "You missed a dose of Cordrazine this morning..."
  }

.. include:: /includes/student-notes.rst


Solution: Document - medications
--------------------------------

.. code-block:: javascript

  {
    _id : ObjectId(...),
    name : "Cordrazine",
    dosage_type : "pill",
    dosage_mass_in_grams : 1.77,
    image : "http://s.quickmeme.com/img/94/945bdf761cb888c7c8e829878ed3b5a0221fd0d10db7b5697834ded0ad592c93.jpg",
    info : "Cordrazine is a strong chemical stimulant useful for...",
    interactions : [
      { medication_id : ObjectId(...), name : "Bio-Memetic Gel" },
      { ... }, ...
    ],
    manufacturer : "Ferengi Pharmaceuticals"
  }

.. include:: /includes/student-notes.rst


Solution: Write - heartbeat for a Pill Bottle
---------------------------------------------

.. code-block:: javascript

  db.bottle_heartbeats.insertOne(
  {
    bottle_id : ObjectId(...),
    medication : "Cordrazine",
    user_id : "...",
    time : ISODate()
  }

.. include:: /includes/student-notes.rst


Solution: Write - Pill Bottle, Opened
-------------------------------------

.. code-block:: javascript

  db.bottle_actions.insertOne(
  {
    bottle_id : ObjectId(...),
    user_id : "...",
    mass_of_contents : 44.25,
    number_of_pills : 25,
    time : ISODate(),
    action : "opened"
  }

.. include:: /includes/student-notes.rst


Solution: Write - Pill Bottle, Closed
-------------------------------------

.. code-block:: javascript

  db.bottles.insertOne(
  {
    bottle_id : ObjectId(...),
    user_id : "willcross",
    mass_of_contents : 42.48,
    number_of_pills : 24,
    time : ISODate(),
    action : "closed",
    pills_taken : 1
  } )

.. include:: /includes/student-notes.rst


Solution: Write - Web Server, Create User
-----------------------------------------

.. code-block:: javascript

  db.users.insertOne( { <user doc; see above> } )

.. include:: /includes/student-notes.rst


Write - Web Server, User Update
-------------------------------

.. code-block:: javascript

  db.users.updateOne( { _id : "willcross" },
  {
    $set : { bottles = [ { ... }, ... ] }
  } )

Examples:

- User buys a new bottle
- User changes a medication in a bottle
- User changes contact information

.. include:: /includes/student-notes.rst


Solution: Query - Web Server, Fetch User Information
----------------------------------------------------

.. code-block:: javascript

  db.users.findOne( { _id : ObjectId(...), password_hash : "..." },
                    { _id : 0, user : 1, contact_info : 1, bottles : 1 } )

.. include:: /includes/student-notes.rst


Solution: Query - Web Server, Fetch History of Pills Taken for the Month
------------------------------------------------------------------------

.. code-block:: javascript

  db.bottle_actions.find(
    { user_id : "username", time : { $gte : <one month ago> } },
    { _id : 0, bottle_id : 1, time : 1, pills_taken : 1 }
  ).sort( { bottle_id : 1, time : 1 } )


Solution: Query - Server, checking for Pills Not Taken
------------------------------------------------------

.. code-block:: javascript

  db.bottle_actions.find(
  { bottle_id : ObjectId(...),
    time : { $gte : ISODate(...), $lte : ISODate(...) },
    action : "closed" },
  { _id : 0, time : 1, action : 1, pills_taken : 1 }
  ).sort( { time : 1 } )

  // if pill hasn't been taken:
  db.notifications.insertOne(
    {
      _id : ObjectId(...),
      user_id : ObjectId(...),
      time_sent : ISODate(...),
      type : "SMS",
      target : "(555) 555-5555",
      message : "You missed a dose of Cordrazine this morning..."
    } )

.. include:: /includes/student-notes.rst


Solution: Query - Server, checking for Last Heartbeat
-----------------------------------------------------

.. code-block:: javascript

  db.bottle_heartbeats.find(
    {
      user_id : ObjectId(...),
      bottle_id : ObjectId(...)
    }, { time : 1 }
  ).sort( { time : -1 } ).limit(1)


Solution: Indexes
-----------------

.. code-block:: javascript

  db.bottle_actions.createIndex( {
      user_id : 1, action : 1, bottle_id : 1,
      time : 1, pills_taken : 1
    } )

  db.bottle_heartbeats.createIndex(
    { time : 1 }, { expireAfterSeconds : 604800 }
  ) // TTL: Delete the heartbeats after 1 week.

  db.bottle_heartbeats.createIndex(
    { user_id : 1, bottle_id : 1, time : 1 }
  )

.. include:: /includes/student-notes.rst

.. only:: instructor

  .. note::

    There's no need to create an index on the ``users`` collection, since
    we're querying by _id (which is unique) in the find/updates, and indexes
    don't help with inserts.


Sharding
--------

From a data point of view:

- Not needed for userdata or medications.
- Would be needed to keep heartbeats over a long period of time, if we couldn't
  use a TTL index to delete them.

From an operation point of view:

- 5M writes per seconds is a lot for a simple replica set.
  Either shard, or reduce the number of writes

.. include:: /includes/student-notes.rst


Good shard key for "bottle_heartbeats" collection
-------------------------------------------------

Good options:

A) ``{ user_id: 1,  bottle_id : 1, time : 1 }``

B) ``{ bottle_id: 1, time : 1 }``

Since we already have an index that matches ``A.``, let's use that.

.. note::

  - Including the ``time`` field ensures good cardinality.
  - Putting the time field after another field ensures that there will never be
    a "hot" server for the inserts.

.. include:: /includes/student-notes.rst

.. only:: instructor

  .. note::

    "Hot" servers happen in cases where a shard key has values that are
    monotonically increasing with time. In these cases, one chunk will include
    the range from ``<some point in the past>`` to ``MaxKey``, and all inserts
    will go to that server.

    Reference: https://docs.mongodb.com/manual/core/sharding-shard-key/#monotonically-changing-shard-keys


[WC/DC] summary of issues to Work On
------------------------------------

- do we want to move the heartbeat?

  - [WC] - Broke it out into a separate collection.

  - [WC] - also gave it a TTL index so we don't keep those heartbeats for ever.

- 5M writes per seconds is a lot

  - be careful about the number of indexes associated with the heartbeat

- detail the ratio of reads/writes per collection
