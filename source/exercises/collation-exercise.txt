=========================
Lab: Collation with Views
=========================


Exercise Step: Inserting the data
---------------------------------

Creating a view with collation allows us to specify a collation other than the default,
or if no default to simplify our queries.

- Let's go ahead and create a view with a collation on a collection that doesn't have a default.
- Start by inserting the necessary dataset from ``usb_drive/names.json``. Copy the contents of the file and then:

.. code-block:: javascript

   mongo
   > use names
   > db.unspecified.insertMany(...) // paste the contents of the file here

.. only:: instructor

   .. note::

      .. code-block:: javascript

         db.unspecified.find().sort( { name: 1 } )

.. include:: /includes/student-notes.rst

Exercise : View Creation Instructions
-------------------------------------

Once you've verified the data insertion was successful, create a view that returns names sorted according to Portuguese rules.

- Verify your work by querying the view and sorting on the name property

.. only:: instructor

  .. note::

      .. code-block:: javascript

      	use names;
        db.createView("portuguese", "unspecified", [
            { $match: { } }
          ],
          { collation: { locale: "pt" } }
        )
        db.portuguese.find().sort({name: 1})

.. include:: /includes/student-notes.rst

Exercise : Index creation with Collation
----------------------------------------

If we run our query on the view using ``explain("executionStats")``, we will see that the query is grossly inefficient.

- Create an index on the source collection that specifies the Portuguese collation
- Use ``explain`` to see the query performance of the view

.. only:: instructor

  .. note::

     .. code-block:: javascript

      	use names;
        db.unspecified.createIndex( {name: 1}, { collation: { locale: "pt" } } )

     Although the index is created, the view should not benefit from this yet. The students will have to destroy the view and create a new one
     that benefits from this index

Exercise: Using an underlying Collation Index with a view
---------------------------------------------------------

- Destroy the ``portuguese`` view and create a new view that benefits from the index
- Verify that there is no ``COLLSCAN`` or ``SORT_KEY_GENERATOR``

.. only:: instructor

   .. note::

      .. code-block:: javascript

         db.createView("portuguese", "unspecified", [
            { $match: {name: { $exists: true } } },
            { $project: { _id: 0, name: 1 } }
           ],
           { collation: { locale: "pt" } }
         )

.. include:: /includes/student-notes.rst

Exercise: Create a Case Insensitive Index
-----------------------------------------

It can be useful to create a case-insensitive index with Collation.

- Delete the existing index, and create a new case-insensitive index for the view to use

.. only:: instructor

   .. note::

      Documentation `here <https://docs.mongodb.com/manual/reference/method/db.collection.createIndex/#collation-and-index-use>`_

      .. code-block:: javascript

         db.unspecified.dropIndex( { name: 1 } )
         db.unspecified.createIndex( { name: 1 }, { collation: { locale: "pt", strength: 1 } } )

.. include:: /includes/student-notes.rst
