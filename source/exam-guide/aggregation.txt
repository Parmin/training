Aggregation
-----------

On the exam, students should be able to:

- Make an analogy between the aggregation pipeline and UNIX pipes
- Specify appropriate Aggregation stages for an aggregation query
- Know the usage of all aggregation operators

Topics
------

- Introduction
- Pipeline behavior
- Stages

  - Top-level operators
  - Query and accumulation operators

- Aggregation Mechanics

  - Pipeline size (in documents)

    - How some stages affect this number

  - Memory limits in the aggregation pipeline
  - allowDiskUse flag

- Explaining aggregation queries


Introduction
------------

The Aggregation Pipeline is MongoDB's answer to SQL's GROUP BY statements. It allows you to combine data from multiple documents in a collection, and perform some basic arithmetic and statistical operations on them.

The Pipeline is in analogy with UNIX pipes. Each stage takes inputs and outputs, but for the Aggregation pipeline, these are documents. You begin with a collection, and filter, transform, and combine documents as you go along. When you are done, you can either view your results, or output them to another collection.

The Aggregation section is emphasized much more heavily in Dev exams than in DBA exams, but you should be familiar with the basic concepts and format of aggregation queries even for the DBA exam.

- Videos:

  - `The Aggregation Pipeline <https://university.mongodb.com/videos/y/AuO8CEkTG6Y>`_

- Docs:

  - :manual:`Aggregation Introduction</core/aggregation-introduction/>`
  - :manual:`Aggregation Pipeline</core/aggregation-pipeline/>`



Aggregation Stages
------------------

Each aggregation stage performs an operation. You should know each of them.

- Video:

  - `Using a document for _id <https://university.mongodb.com/videos/y/zoN4cj_XQzY>`_
  - `Aggregation Expressions <https://university.mongodb.com/videos/y/L4G14MTfTgQ>`_
  - `Using $project <https://university.mongodb.com/videos/y/TbQ2PI5Fib0>`_
  - `Using $match <https://university.mongodb.com/videos/y/7RtHG90Hrbw>`_
  - `Using $text <https://university.mongodb.com/videos/y/LpDSge_GbpI>`_
  - `Using $sort <https://university.mongodb.com/videos/y/HUEtV7omSb8>`_
  - `Using $limit and $skip <https://university.mongodb.com/videos/y/o5hzYKXUyrU>`_
  - `Using $unwind <https://university.mongodb.com/videos/y/E4aYOQPeQvI>`_
  - `Using $out <https://university.mongodb.com/videos/y/b1dfUSrTPto>`_

- Docs:

  - :manual:`Aggregation Pipeline Quick Reference</meta/aggregation-quick-reference/>`


Aggregation Operators
---------------------

Some stages come with their own operators; you should be familiar with these. For example, $match uses all of the standard MongoDB CRUD query operators, such as $in, $or, and $gte. Refer to the CRUD db.collection.find() section for more information. $group, on the other hand, has unique accumulator operators to combine documents passed to this pipeline; even when they look familiar from CRUD (like $push), you should learn the $group versions, and how they work.

- Videos:

- `Using $sum <https://university.mongodb.com/videos/y/93MSz3uDC1A>`_
- `Using $avg <https://university.mongodb.com/videos/y/baIDZ-M5j7w>`_
- `Using $addToSet <https://university.mongodb.com/videos/y/YzURaZnKI9s>`_
- `Using $push <https://university.mongodb.com/videos/y/LQcBM-g0ACY>`_
- `Using $max and $min <https://university.mongodb.com/videos/y/BYoNX4trjOQ>`_
- `Double $group Stages <https://university.mongodb.com/videos/y/EIWF9Oxeb8M>`_
- `Revisiting $first and $last <https://university.mongodb.com/videos/y/JOdAnxVAMwc>`_

- Docs:

- :manual:`$match</reference/operator/aggregation/match/#pipe._S_match>`
- :manual:`$group</reference/operator/aggregation/group/#pipe._S_group>`
- :manual:`Aggregation Pipeline Operators</reference/operator/aggregation/>`



Aggregation Mechanics
---------------------

Aggregation Limits

  - From pipeline size to sorting, you should be aware of the limits that apply to the Aggregation pipeline.

- Video:

  - `Aggregation Limits <https://university.mongodb.com/videos/y/U_gRSxEq3c0>`_


Aggregation Optimization
------------------------

MongoDB will optimize Aggregation_ in some cases. Be aware of those cases & how it works.

- Docs:

  - :manual:`Optimizing the Aggregation Pipeline</core/aggregation-pipeline-optimization/>`
  - :manual:`Aggregation Limits</core/aggregation-pipeline-limits/>`


Aggregation Techniques
----------------------

Be aware of how to build an aggregation pipeline for a desired output.

- Video:

  - `Compound Grouping <https://university.mongodb.com/videos/y/qTbtax_cKcc>`_
  - `Double Unwind <https://university.mongodb.com/videos/y/YXGL27217B8>`_
  

Aggregation Options
-------------------

- Docs:

  - :manual:`db.collection.aggregate()</reference/method/db.collection.aggregate/>`

- Video:

  - `Aggregation Options <https://university.mongodb.com/videos/y/0CGNVacCrY8>`_


Aggregation Examples
--------------------

More than any other section, Aggregation is about practice. Here are some examples to give you some ideas and help you to get started.

- Videos:

  - `Simple Aggregation Example <https://university.mongodb.com/videos/y/DQBXCsjeO5c>`_
  - `Simple Aggregation Expanded <https://university.mongodb.com/videos/y/3lEpnMcfpCs>`_
  - `$unwind Example <https://university.mongodb.com/videos/y/U_4Enh2TTp4>`_
  - `Compound Grouping <https://university.mongodb.com/videos/y/qTbtax_cKcc>`_

- Docs: 

  - :manual:`Single Purpose Aggregation Operations</core/single-purpose-aggregation/>`
  - :manual:`Aggregation with Zip Code Data</tutorial/aggregation-zip-code-data-set/>`
  - :manual:`Aggregation with User Preference Data</tutorial/aggregation-with-user-preference-data/>`


Exercises
---------

- Find or build a data set. Perform an aggregation to see how many documents contain a field within a given range.
- Count all of the elements in an array field, summed accross all documents in the collection.
- Count only the elements in an array field above a certain value.
- Count only the elements in an array field where another field has a certain value.
