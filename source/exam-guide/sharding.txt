========
Sharding
========

On the certification exam, we will attempt to verify that you:

- Know the benefits of sharding
- Know how to construct a good shard key, and what can go wrong with selecting a shard key
- Understand the balancer
- Know the role of the config servers and how they work.

Sharding Subtopics
------------------

- Introduction
- The Shard Key

  - Other indexes in a sharded cluster

- Chunks

  - Which chunk a document belongs to
  - Chunk ranges
  - Chunk "size"
  - Chunk Splits (DBA only)
  - Config Servers and Cluster Metadata (DBA only)

- Config Servers and Cluster Metadata

  - The Config DB
  - Sharding Processes

- Pre-splitting data (DBA only)
- Balancing

  - Balancer
  - Chunk Migration

- Queries in a Sharded Cluster

  - The Mongos
  - Targeted
  - Scatter-gather
  - Index Usage
  - Primary shard
  - Sorting Queries in a Sharded Cluster

- Choosing a Shard Key

  - Properties of Bad Shard Keys

    - Problems that bad shard keys cause

  - Properties of Good Shard Keys

    - Cardinality
    - Selectivity

  - Hashed Shard Keys

    - What problem they solve
    - What problem they cause

- Primary Shard


Introduction
------------

Sharding is about scaling. With sharding, you can distribute your data across several replica sets, each of which is a logical "node" in the sharded cluster.

Note that sharding is largely orthogonal to Replication, which is about data durability and availability.

- Docs:

  - :manual:`Sharding Introduction</core/sharding-introduction/>`
  - :manual:`Sharded Cluster Components</core/sharded-cluster-components/>`
  - :manual:`Shards</core/sharded-cluster-shards/>`

- Video:

  - `Introduction to Sharding <https://youtu.be/_GfDqa1qRl0?t=35s>`_
  - `Sharding and Data Distribution <https://university.mongodb.com/videos/y/xvWzS9j7IIY>`_


The Shard Key
-------------

The Shard Key determines which data ends up on which shard. Each document must contain the shard key, and it is immutable.

Because of reliance on the shard key, there are implications for data modeling that should be considered in a sharded cluster.

- Docs:

  - :manual:`Shard Keys</core/sharding-shard-key/>`
  - `Shard Key Indexes <http://docs.mongodb.org/master/core/sharding-shard-key-indexes/>`_
  - `Unique Keys <http://docs.mongodb.org/v2.6/tutorial/enforce-unique-keys-for-sharded-collections/>`_


Chunks
------

Chunks are logical groupings of the sharded collection, and they each live on one server.

While a chunk is useful in that it determines where documents live, don't just think of a chunk as a bunch of documents -- think of it as a range of the shard key. All documents with a shard key value in that range live on that shard, but you can have chunks without documents.

- Docs:

  - :manual:`Chunk (glossary entry)</reference/glossary/#term-chunk>`
  - :manual:`Chunk Splits in a Sharded Cluster</core/sharding-chunk-splitting/ >`

- Videos:

  - `Chunks and Operations <https://university.mongodb.com/videos/y/v7Gibss9JAk>`_


Config Servers and Cluster Metadata
-----------------------------------

The config servers hold all metadata for the cluster, though the routers (mongos's) will create cached versions, as well.

- Docs:

  - :manual:`Config Servers</core/sharded-cluster-config-servers/>`
  - `Sharded Cluster Metadata <http://docs.mongodb.org/master/core/sharded-cluster-metadata/>`_

- Videos:

  - `Config DB <https://university.mongodb.com/videos/y/WVXmIVUGBm4>`_
  - `Cluster Setup Topology <https://university.mongodb.com/videos/y/ZyDNnN8-4Ak>`_
  - `Sharding Processes <https://university.mongodb.com/videos/y/XMnxjcdiMJs>`_


Pre-Splitting Data (DBA Only)
-----------------------------

- Docs:

  - `Create Chunks <http://docs.mongodb.org/master/tutorial/create-chunks-in-sharded-cluster/>`_
  - `Split Chunks <http://docs.mongodb.org/master/tutorial/split-chunks-in-sharded-cluster/>`_
  


Balancing
---------

The cluster doesn't try to balance bytes or documents across the cluster -- it balances "chunks," or ranges of the shard key.

- Docs:

  - `Sharded Collection Balancing <http://docs.mongodb.org/master/core/sharding-balancing/>`_



Queries in a Sharded Cluster
----------------------------

- Docs:

  - `Broadcast Operations <http://docs.mongodb.org/master/core/sharded-cluster-query-router/#broadcast-operations>`_
  - `Targeted Operations <http://docs.mongodb.org/master/core/sharded-cluster-query-router/#targeted-operations>`_
  - `Sharded Cluster Query Routing <http://docs.mongodb.org/master/core/sharded-cluster-query-router/>`_

- Video:

  - `Implications of Sharding <https://university.mongodb.com/videos/y/ig278F60gRA>`_


Choosing a Shard Key
--------------------

- Video:

  - `Choosing a Shard Key <https://university.mongodb.com/videos/y/8q2GB3QSBSI>`_
  - `Shard Key Selection Example <https://university.mongodb.com/videos/y/ujlNVJK5dMc>`_

- Docs:

  - :manual:`Choose a Shard Key</tutorial/choose-a-shard-key/>`
  - `Shard a Collection using a Hashed Shard Key <http://docs.mongodb.org/master/tutorial/shard-collection-with-a-hashed-shard-key/>`_


Primary Shard
-------------

Docs:

  - :manual:`Primary shard</core/sharded-cluster-shards/#primary-shard>`

Exercises
---------

Try to perform the following on your own:

- Spin up a sharded cluster
- Add a shard
- Shard a collection in the cluster.
- Add data to a chunk, and watch as it:

  - Splits
  - Migrates elsewhere (if enough chunks are split)

- View the status of your cluster in the "config" database.
- Manually split a chunk.
- Drain a shard and remove it from the cluster.
