============
Text Indexes
============

Learning Objectives
-------------------

Upon completing this module, students should understand:

- The purpose of a text index
- How to create text indexes
- How to search using text indexes
- How to rank search results by relevance score

.. include:: /includes/student-notes.rst


What is a Text Index?
---------------------

- A text index is based on the tokens (words, etc.) used in string fields.
- MongoDB supports text search for a number of languages.
- Text indexes drop language-specific stop words (e.g. in English "the", "an", "a", "and", etc.)
- Text indexes use simple, language-specific suffix stemming (e.g., "running" to "run")

.. include:: /includes/student-notes.rst


Creating a Text Index
---------------------

You create a text index a little bit differently than you create a standard index.

.. code-block:: javascript

   db.<COLLECTION>.ensureIndex( { <field name> : "text" } )

.. include:: /includes/student-notes.rst


.. include:: /exercises/indexes-text-creation.txt

Creating a Text Index with Weighted Fields
------------------------------------------

- Default weight of 1 per indexed field.
- Weight is relative to other weights in text index.

.. code-block:: javascript

   db.<COLLECTION>.createIndex( 
    { "title" : "text", "keywords": "text", "author" : "text" },
    { "weights" : {
      "title" : 10,
      "keywords" : 5
    }})

- Term match in "title" field has 10 times (i.e. 10:1) the impact as a term match in the "author" field.


Text Indexes are Similar to Multikey Indexes
--------------------------------------------

- Continuing our example, you can treat the ``dialog`` field as a multikey index.
- A multikey index with each of the words in ``dialog`` as values.
- You can query the field using the ``$text`` operator. 

.. include:: /includes/student-notes.rst

.. include:: /exercises/indexes-text-inserting.txt


Querying a Text Index
---------------------

Next, let's query the collection. The syntax is:

.. code-block:: javascript

   db.<COLLECTION>.find( { $text : { $search : "query terms go here" } } )

.. include:: /includes/student-notes.rst

.. include:: /exercises/indexes-text-query-1.txt


.. include:: /exercises/indexes-text-query-2.txt


Search for a Phrase
-------------------

- To match an exact phrase, include search terms in quotes (escaped).
- The following query selects documents containing the phrase "coffee cake":
 
  .. code-block:: javascript
  
     db.montyPython.find( { $text: { $search: "\"European swallow\"" } } )

.. include:: /includes/student-notes.rst


Text Search Score
-----------------

- The search algorithm assigns a relevance score to each search result.
- The score is generated by a vector ranking algorithm. 
- The documents can be sorted by that score.

  .. code-block:: javascript

     db.<COLLECTION>.find(
         { $text : { $search : "swallow coconut"} }, 
         { textScore: {$meta : "textScore" } } 
     ).sort(
             { textScore: { $meta: "textScore" } }
     ) )

.. include:: /includes/student-notes.rst
