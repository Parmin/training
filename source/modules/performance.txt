====================
Performance Tutorial
====================


Learning Objectives
-------------------

Upon completing this module students should understand:

- The tools MongoDB provides for performance analysis

  - mongostat
  - the profiler
  - stats
  - serverStatus

- Tips & tricks to improve performance
 

.. only:: instructor

  .. note::

    - A node.js program for this exists here: 

      - https://github.com/NathanZamecnik/messagequeue/blob/master/index.js

    - I intend to convert this to something the shell can use at some point.
    - Acts as a message queue, writers write to the system while readers read.
    

Performance Tools Overview
--------------------------

- mongostat
- mongotop
- db.collection.stats()
- db.currentOp()
- db.setProfilingLevel()
- db.serverStatus()


Mongostat and Mongotop
----------------------

- Mongostat samples a server every second

  - see current ops, pagefaults, network traffic, etc.
  - does not give a view into historic performance

    - use MMS for that

- Mongotop looks at the time spent on reads/writes in each collection


db.collection.stats()
---------------------

- Used to view the current stats for a collection.
- Everything is in bytes; use the multiplier parameter to view in KB, MB, etc
- You can also use db.stats() to do this at scope of the entire database


.. include:: /exercises/performance-collection-stats.txt


The Profiler
------------

- Off by default; to reset, db.setProfilerLevel(0)
- At setting 1, it captures "slow" queries

    - user may define what "slow" is
    - default is 100ms: db.setProfilerLevel(1)
    - e.g., to capture 20 ms: db.setProfilerLevel(1, 20)


The Profiler (continued)
------------------------

- If the profiler level is 2, it captures all queries.

  - This will severely impact performance.
  - Turs all reads into writes.

- Always turn the profiler off when done (set level to 0)
- When on, the profiler writes to db.system.profile


The system.profile Collection
-----------------------------

- Has the format

.. code-block:: javascript

  {
      "op" : "command",  // can also be "query" or "update"
      "ns" : "test.$cmd",  // often db.collection
      "command" : { "profile" : 0 },
      "keyUpdates" : 0,
      "numYield" : 0,
      "lockStats" :
      {
          "timeLockedMicros" :
          {
              "r" : NumberLong(0),
              "w" : NumberLong(12)
          },
          "timeAcquiringMicros" :
          {
              "r" : NumberLong(0),
              "w" : NumberLong(6)
          }
      },
      "responseLength" : 58,
      "millis" : 0,  // length of time to perform the query
      "execStats" : {  },
      "ts" : ISODate("2014-11-11T19:51:02.459Z"),
      // timestamp is good for querying for a time range
      "client" : "127.0.0.1",
      "allUsers" : [ ],
      "user" : ""
  }

.. include:: exercises/performance-profiler-overview.txt


Server Status
-------------

- Shown by typing db.serverStatus().
- Takes a snapshot.
- By taking diffs, you can see system trends.
- Most of the data that MMS gets is from here.
- Most useful when taking diffs.
