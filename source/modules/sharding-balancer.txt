===================
Sharding - Balancer
===================


Learning Objectives
-------------------

Upon completing this module, students should understand:

- How/When a balancing round starts
- Where data is written/read during a balancing round
- How a balancing round ends
- Criteria for the final state of a balancing round


Start of a Balancing Round
--------------------------

- A balancing round can be initiated by any mongos in the cluster
- A balancing round is started when the chunks on a cluster become imbalanced, based on whether the shard with the most chunks
  
  - A balancing round starts when the shard with the most chunks has 2-8 more chunks than the shard with the fewest, depending on cluster size.

    - 2 when the cluster has <20 chunks
    - 4 when the cluster has 20-79 chunks
    - 8 when the cluster has 80+ chunks


Chunk Migration
---------------

- A chunk migration goes through the following steps:

  1. The balancer process sends the moveChunk command to the source shard.
  2. The source starts the move with an internal command, but continues to process reads/writes during the migration.
  3. The destination shard begins requesting documents in the chunk, and begins receiving copies of the data.
  4. After receiving the final document in the chunk, the destination shard starts a synchronization to ensure it receives changes to the chunk.
  5. When synchronized, the destination shard tells the config db that it has the chunk.
  6. The source shard deletes its copy of the chunk.


The Balancing Round (continued)
-------------------------------

- Each chunk will move from the shard with the most chunks to the shard with the fewest.
- A balancing round ends when all shards differ in their number of chunks by at most one.
