===================
Backup and Recovery
===================


Disasters Do Happen
-------------------

.. include:: disasters-happen.txt

.. include:: /includes/student-notes.rst


.. include:: /includes/np.rst

Human Disasters
---------------

.. include:: human-disasters.txt

.. include:: /includes/student-notes.rst


Terminology: RPO vs. RTO
------------------------

- **Recovery Point Objective (RPO)**: How much data can you afford to lose?

- **Recovery Time Objective (RTO)**: How long can you afford to be off-line?

.. include:: /includes/student-notes.rst


Terminology: DR vs. HA
----------------------

- **Disaster Recovery** (DR)
- **High Availability** (HA)
- Distinct business requirements
- Technical solutions may converge

.. include:: /includes/student-notes.rst


Quiz
----

- Q: What's the hardest thing about backups?
- A: Restoring them!
- **Regularly test that restoration works!**

.. include:: /includes/student-notes.rst


Backup Options
--------------

- Document Level

  - Logical
  - ``mongodump``, ``mongorestore``

- File system level

  - Physical
  - Copy files
  - Volume/disk snapshots

.. include:: /includes/student-notes.rst


Document Level: ``mongodump``
-----------------------------

- Dumps collection to BSON files
- Mirrors your structure
- Can be run live or in offline mode
- Does not include indexes (rebuilt during restore)
- ``--dbpath`` for direct file access
- ``--oplog`` to record oplog while backing up
- ``--query/filter`` selective dump

.. include:: /includes/student-notes.rst


``mongodump``
-------------

.. code-block:: bash

   $ mongodump --help
   Export MongoDB data to BSON files.

   options:
     --help                  produce help message
     -v [ --verbose ]        be more verbose (include multiple times for
                             more verbosity e.g. -vvvvv)
     --version               print the program's version and exit
     -h [ --host ] arg       mongo host to connect to ( /s1,s2 for
     --port arg              server port. Can also use --host hostname
     -u [ --username ] arg   username
     -p [ --password ] arg   password
     --dbpath arg            directly access mongod database files in path
     -d [ --db ] arg         database to use
     -c [ --collection ] arg collection to use (some commands)
     -o [ --out ] arg (=dump)output directory or "-" for stdout
     -q [ --query ] arg      json query
     --oplog                 Use oplog for point-in-time snapshotting

.. include:: /includes/student-notes.rst


File System Level
-----------------

- **Must use journaling!**
- Copy ``/data/db`` files
- Or snapshot volume (e.g., LVM, SAN, EBS)
- *Seriously, always use journaling!*

.. include:: /includes/student-notes.rst

Ensure Consistency
------------------

Flush RAM to disk and stop accepting writes:

- ``db.fsyncLock()``
- Copy/Snapshot
- ``db.fsyncUnlock()``

.. include:: /includes/student-notes.rst


File System Backups: Pros and Cons
----------------------------------

- All databases together
- Backup files will be large
- Fastest way to create a backup
- Fastest way to restore a backup

.. include:: /includes/student-notes.rst

.. only:: instructor

    .. note::

        With mmapv1, individual databases' files actually *can* be backed up/restored independently, but not with wiredTiger


Document Level: ``mongorestore``
--------------------------------

- ``mongorestore``
- ``--oplogReplay`` replay oplog to point-in-time

.. include:: /includes/student-notes.rst


File System Restores
--------------------

- All database files
- Replay Oplog

.. include:: /includes/student-notes.rst


Backup Sharded Cluster
----------------------

1. Stop Balancer (and wait) or no balancing window
2. Stop one config server (data R/O)
3. Backup Data (shards, config)
4. Restart config server
5. Resume Balancer

.. include:: /includes/student-notes.rst

.. only:: instructor

    .. note::

        Stopping one config server is sufficient even with a CSRS

Restore Sharded Cluster
-----------------------

1. Dissimilar # shards to restore to
2. Different shard keys?
3. Selective restores
4. Consolidate shards
5. Changing addresses of config/shards

.. include:: /includes/student-notes.rst


Tips and Tricks
---------------

- ``mongodump/mongorestore``

  - ``--oplog[Replay]``
  - ``--objcheck/--repair``
  - ``--dbpath``
  - ``--query/--filter``

- ``bsondump``

  - inspect data at console

- LVM snapshot time/space tradeoff

  - Multi-EBS (RAID) backup
  - clean up snapshots

.. include:: /includes/student-notes.rst


Backup Options
--------------

- You can do it yourself as outlined in this section so far
- Or have the people who created MongoDB run your backups

.. include:: /includes/student-notes.rst


Ops Manager Backup
------------------

.. include:: mms-backup.txt

.. include:: /includes/student-notes.rst


Sharded Clusters
----------------

- Balancer paused every 6 hours
- A no-op token is inserted across all shards, mongos instances, and config servers
- Oplog applied to replica sets until point in which token was inserted
- Provides a consistent state of database across shards

.. include:: /includes/student-notes.rst


Under the Hood
--------------

- From the initial sync, we rebuild your data in our datacenters and take a snapshot
- We take snapshots every 6 hours
- Oplog is stored for 48 hours

.. include:: /includes/student-notes.rst


Key Benefits
------------

- Point in time backups
- Easy to restore
- Unlimited resources
- Fully managed

.. include:: /includes/student-notes.rst


Point in Time Backups
---------------------

- Oplog stored for 48 hours
- Restore your replica set to any point-in-time in the last 48 hours by creating a custom snapshot

.. include:: /includes/student-notes.rst


Easy to Restore
---------------

- Pull from custom URL
- Push via scp

.. include:: /includes/student-notes.rst


Unlimited Restores
------------------

- Confidence in your restore process
- Build development, QA, analytics environments without impacting production

.. include:: /includes/student-notes.rst


Fully Managed
-------------

- Created by the engineers that build MongoDB
- No need to write or maintain custom backup scripts

.. include:: /includes/student-notes.rst


Getting Started
---------------

- Go to https://mms.mongodb.com and sign up

.. include:: /includes/student-notes.rst
